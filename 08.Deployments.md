### **Section C: Core Kubernetes Concepts**

---

#### **8. Deployments**

Deployments are a higher-level abstraction in Kubernetes that manage the lifecycle of Pods and ReplicaSets. They provide robust mechanisms for deploying applications, handling updates, and scaling.

##### **8.a. Overview of Deployments**

- **What is a Deployment?**
  - A Deployment is a Kubernetes object that manages a set of Pods and ReplicaSets. It ensures that the desired state of the application is maintained by managing the Pods and ReplicaSets according to the specified configuration.
  - **Key Responsibilities:**
    - **Declarative Updates:** Allows you to declaratively update Pods and manage the rollout of changes.
    - **Scaling:** Supports scaling the number of Pods up or down.
    - **Rollbacks:** Facilitates rolling back to previous versions if necessary.

- **Components of a Deployment:**
  - **Pod Template:** Defines the Pods that will be created by the Deployment, including the container image, ports, and environment variables.
  - **ReplicaSet:** Automatically managed by the Deployment, ensuring the desired number of Pods are running.
  - **Strategy:** Defines how updates to the Pods are handled, including rolling updates and recreates.
  - **Selector:** Determines which Pods are managed by the Deployment based on labels.

- **Deployment Manifest Example:**
  ```yaml
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: my-deployment
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: my-app
    template:
      metadata:
        labels:
          app: my-app
      spec:
        containers:
        - name: my-container
          image: nginx:latest
          ports:
          - containerPort: 80
  ```

##### **8.b. Rolling Updates and Rollbacks**

- **Rolling Updates:**
  - **Purpose:** Allows you to update the application with zero downtime by incrementally updating Pods with new versions of the container image.
  - **How it Works:**
    - **Update Strategy:** Kubernetes updates Pods in a rolling fashion, ensuring that a certain number of Pods are always available during the update.
    - **Max Surge and Max Unavailable:** Configure the number of Pods that can be created above the desired count (`maxSurge`) and the number of Pods that can be unavailable during the update (`maxUnavailable`).
  - **Example Configuration:**
    ```yaml
    spec:
      strategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 1
    ```

- **Rollbacks:**
  - **Purpose:** Provides a mechanism to revert to a previous stable version of the Deployment if the new version causes issues.
  - **How it Works:**
    - **History:** Kubernetes maintains a history of revisions, allowing you to roll back to any previous version.
    - **Rollback Command:** Use `kubectl rollout undo` to revert to the previous version.
  - **Example Command:**
    ```sh
    kubectl rollout undo deployment/my-deployment
    ```

##### **8.c. Scaling Deployments**

- **Scaling Up and Down:**
  - **Manual Scaling:** Change the number of replicas in the Deployment to scale the number of Pods. Kubernetes will create or delete Pods to match the desired count.
  - **Example Command for Scaling Up:**
    ```sh
    kubectl scale deployment my-deployment --replicas=5
    ```
  - **Example Command for Scaling Down:**
    ```sh
    kubectl scale deployment my-deployment --replicas=2
    ```

- **Horizontal Pod Autoscaling (HPA):**
  - **Purpose:** Automatically adjusts the number of Pods based on CPU utilization or custom metrics.
  - **How it Works:**
    - **Metrics:** HPA monitors metrics like CPU utilization and scales the number of Pods accordingly.
    - **Configuration:** Define an HPA object specifying the target metrics and scaling behavior.
  - **Example HPA Configuration:**
    ```yaml
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    metadata:
      name: my-hpa
    spec:
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: my-deployment
      minReplicas: 2
      maxReplicas: 10
      targetCPUUtilizationPercentage: 50
    ```

##### **8.d. Managing Deployment Strategies**

- **Strategy Types:**
  - **Rolling Update:** Gradually replaces old Pods with new Pods, ensuring minimal downtime. This is the default strategy for Deployments.
  - **Recreate:** Terminates all existing Pods before creating new Pods. This can be useful for applications where a full restart is required.
  - **Custom Strategies:** Kubernetes allows for custom update strategies via the `strategy` field in the Deployment spec.

- **Update Strategy Configuration:**
  - **Rolling Update Configuration:**
    ```yaml
    spec:
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 1
    ```
  - **Recreate Strategy Configuration:**
    ```yaml
    spec:
      strategy:
        type: Recreate
    ```

##### **8.e. Code Sample: Deploying an Application**

- **Deploying a Simple Application:**
  - **Create a Deployment YAML file (`deployment.yaml`):**
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: web-deployment
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: web
      template:
        metadata:
          labels:
            app: web
        spec:
          containers:
          - name: web-container
            image: httpd:latest
            ports:
            - containerPort: 80
    ```
  - **Apply the Deployment:**
    ```sh
    kubectl apply -f deployment.yaml
    ```
  - **Check the Deployment Status:**
    ```sh
    kubectl get deployments
    kubectl get pods
    ```
  - **Updating the Deployment:**
    - **Edit the YAML file** (e.g., change the container image version) and reapply:
      ```sh
      kubectl apply -f deployment.yaml
      ```
    - **Verify the Rollout Status:**
      ```sh
      kubectl rollout status deployment/web-deployment
      ```
  - **Rolling Back to a Previous Version:**
    ```sh
    kubectl rollout undo deployment/web-deployment
    ```

---

These notes provide a comprehensive understanding of Deployments, covering their purpose, update strategies, scaling, and practical deployment examples. This section will help you effectively manage application lifecycles and deployments in Kubernetes.
