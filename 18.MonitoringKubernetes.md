### **Section E: Monitoring, Logging, and Troubleshooting**

---

#### **18. Monitoring Kubernetes**

Monitoring is a critical aspect of managing and maintaining a Kubernetes cluster. It helps in identifying performance bottlenecks, ensuring the health of applications, and proactively detecting issues before they impact end users. This section covers the essential tools and practices for monitoring Kubernetes.

---

##### **18.a. Understanding Kubernetes Monitoring Tools**

- **Importance of Monitoring in Kubernetes:**
  - Monitoring provides visibility into the performance and health of the cluster and its workloads.
  - It helps in tracking resource utilization, detecting anomalies, and ensuring that applications are running smoothly.

- **Key Monitoring Tools for Kubernetes:**
  - **Prometheus:**
    - An open-source monitoring system and time-series database.
    - Scrapes metrics from various sources and provides powerful query capabilities using PromQL.
    - Commonly used with Grafana for visualizing metrics.
  - **Grafana:**
    - An open-source platform for monitoring and observability.
    - Integrates with Prometheus to create dashboards and alerts.
    - Supports multiple data sources and provides a wide range of visualization options.
  - **Kubernetes Metrics Server:**
    - A lightweight aggregator of resource usage data in the cluster.
    - Provides metrics like CPU and memory usage, which can be accessed through the Kubernetes API.
    - Used by the Horizontal Pod Autoscaler (HPA) to scale pods based on resource utilization.

- **Other Monitoring Tools:**
  - **Thanos:** Highly available Prometheus setup for long-term storage of metrics.
  - **Jaeger:** Distributed tracing system for monitoring microservices.
  - **Elastic Stack (ELK):** Collects and visualizes logs and metrics, can be integrated with Kubernetes.

---

##### **18.b. Prometheus and Grafana Integration**

- **Setting Up Prometheus in Kubernetes:**
  - **Deploying Prometheus:**
    - Prometheus can be deployed in Kubernetes using a Helm chart or a custom YAML configuration.
    - It requires setting up a `ConfigMap` for the Prometheus configuration and deploying the Prometheus server.

    ```yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: prometheus-config
      namespace: monitoring
    data:
      prometheus.yml: |
        global:
          scrape_interval: 15s
        scrape_configs:
          - job_name: 'kubernetes-apiservers'
            kubernetes_sd_configs:
            - role: endpoints
            relabel_configs:
            - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
              action: keep
              regex: default;kubernetes;https
    ```

  - **Service Discovery:**
    - Prometheus uses Kubernetes service discovery to automatically discover targets like nodes, pods, and services.

- **Setting Up Grafana for Visualization:**
  - **Deploying Grafana:**
    - Grafana can be deployed in Kubernetes using a Helm chart or custom YAML files.
    - Once deployed, you can add Prometheus as a data source and create dashboards to visualize metrics.

    ```yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: grafana-datasources
      namespace: monitoring
    data:
      datasources.yaml: |
        apiVersion: 1
        datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-server.monitoring.svc.cluster.local
          access: proxy
    ```

  - **Creating Dashboards:**
    - Grafana provides pre-built dashboards for Kubernetes metrics, or you can create custom dashboards using PromQL queries.
    - Common dashboards include node resource usage, pod metrics, and application performance.

- **Setting Up Alerts:**
  - Prometheus supports alerting rules that trigger alerts based on specific conditions.
  - Alerts can be integrated with tools like Alertmanager, Slack, or email for notifications.

    ```yaml
    groups:
    - name: example
      rules:
      - alert: HighPodCPU
        expr: sum(rate(container_cpu_usage_seconds_total{image!="",namespace="default"}[5m])) by (pod) > 0.5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using high CPU"
    ```

---

##### **18.c. Setting Up Kubernetes Metrics Server**

- **What is the Kubernetes Metrics Server?**
  - The Metrics Server is a scalable, efficient source of resource metrics for Kubernetes built-in autoscaling pipelines.
  - It collects metrics like CPU and memory usage from the kubelet and exposes them through the Kubernetes API.

- **Installing the Metrics Server:**
  - The Metrics Server can be installed using `kubectl` or Helm.

  ```sh
  kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
  ```

- **Using Metrics for Autoscaling:**
  - Once the Metrics Server is installed, you can use it with the Horizontal Pod Autoscaler (HPA) to automatically scale pods based on resource usage.

  ```yaml
  apiVersion: autoscaling/v1
  kind: HorizontalPodAutoscaler
  metadata:
    name: nginx-hpa
  spec:
    scaleTargetRef:
      apiVersion: apps/v1
      kind: Deployment
      name: nginx
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 50
  ```

- **Viewing Metrics with kubectl:**
  - You can use the `kubectl top` command to view metrics collected by the Metrics Server.

  ```sh
  kubectl top nodes
  kubectl top pods --namespace=default
  ```

---

##### **18.d. Code Sample: Monitoring Kubernetes with Prometheus and Grafana**

- **Step 1: Deploy Prometheus and Grafana using Helm**
  - Install Helm if not already installed.
  - Add the Prometheus community Helm repository and install the Prometheus stack.

  ```sh
  helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  helm repo update
  helm install prometheus prometheus-community/kube-prometheus-stack --namespace monitoring --create-namespace
  ```

- **Step 2: Access Grafana Dashboard**
  - Once deployed, forward the Grafana service to access the dashboard.

  ```sh
  kubectl port-forward svc/prometheus-grafana 3000:80 --namespace monitoring
  ```

  - Access Grafana at `http://localhost:3000` using the default credentials (username: admin, password: prom-operator).

- **Step 3: Create a Dashboard in Grafana**
  - Add Prometheus as a data source in Grafana.
  - Create a new dashboard and add panels for metrics such as CPU and memory usage.

- **Step 4: Create Alerts**
  - Configure alert rules in Prometheus for critical metrics.
  - Set up Alertmanager to route alerts to the desired notification channels.

---

Monitoring Kubernetes is essential for maintaining the health and performance of your applications. By using tools like Prometheus and Grafana, you can gain insights into the resource usage and operational state of your cluster. Setting up the Kubernetes Metrics Server allows you to leverage autoscaling and monitor resource metrics directly through the Kubernetes API.
