### **Section C: Core Kubernetes Concepts**

---

#### **11. Persistent Storage in Kubernetes**

In Kubernetes, managing persistent data is crucial for applications that need to retain data beyond the lifecycle of individual Pods. Kubernetes provides a robust storage system that includes Persistent Volumes (PVs), Persistent Volume Claims (PVCs), and Storage Classes to manage persistent data effectively.

##### **11.a. Understanding Persistent Volumes and Persistent Volume Claims**

- **Persistent Volumes (PVs):**
  - **Overview:**
    - A Persistent Volume is a storage resource in the cluster that has been provisioned by an administrator or dynamically created using Storage Classes. PVs are independent of Pods and can outlive the life of a Pod.
  - **Characteristics:**
    - **Decoupled Storage:** PVs are not tied to any specific Pod, making them resilient to Pod restarts or terminations.
    - **Cluster Resource:** PVs are part of the clusterâ€™s resources and can be shared among different Pods.
  - **Types of PVs:**
    - **NFS:** Network File System, allows sharing files between multiple Pods.
    - **iSCSI:** Block storage, can be used as a traditional disk drive.
    - **Cloud Provider Storage:** EBS (AWS), PD (GCP), Azure Disk.

- **Persistent Volume Claims (PVCs):**
  - **Overview:**
    - PVCs are requests for storage by a user. They are similar to a Pod requesting a specific amount of resources (like CPU or memory).
  - **Binding PVs and PVCs:**
    - A PVC will automatically bind to a PV that meets its requirements (capacity, access mode, storage class).
  - **Access Modes:**
    - **ReadWriteOnce (RWO):** Mounted as read-write by a single node.
    - **ReadOnlyMany (ROX):** Mounted as read-only by multiple nodes.
    - **ReadWriteMany (RWX):** Mounted as read-write by multiple nodes.

- **Example Configuration of PV and PVC:**
  ```yaml
  apiVersion: v1
  kind: PersistentVolume
  metadata:
    name: my-pv
  spec:
    capacity:
      storage: 10Gi
    accessModes:
      - ReadWriteOnce
    persistentVolumeReclaimPolicy: Retain
    storageClassName: manual
    hostPath:
      path: /mnt/data
  ```

  ```yaml
  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: my-pvc
  spec:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 8Gi
    storageClassName: manual
  ```

##### **11.b. Storage Classes and Dynamic Provisioning**

- **Storage Classes:**
  - **Purpose:**
    - Storage Classes define the types of storage available in the cluster, specifying the provisioner (e.g., AWS EBS, GCE PD), parameters, and reclaim policy.
  - **Dynamic Provisioning:**
    - Dynamic provisioning allows Kubernetes to automatically create a PV based on the requirements specified in the PVC and the Storage Class. This eliminates the need for administrators to manually provision storage.
  - **Example Storage Class Configuration:**
    ```yaml
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: fast
    provisioner: kubernetes.io/aws-ebs
    parameters:
      type: gp2
      zone: us-west-2a
    reclaimPolicy: Delete
    ```

- **Using Storage Classes in PVCs:**
  - When a PVC specifies a `storageClassName`, Kubernetes uses that class to dynamically provision a PV that satisfies the claim.
  - **Example PVC with Dynamic Provisioning:**
    ```yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: dynamic-pvc
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: fast
    ```

##### **11.c. StatefulSets and Persistent Data Management**

- **StatefulSets Overview:**
  - **Purpose:**
    - StatefulSets manage the deployment and scaling of a set of Pods with persistent identities and stable storage. Unlike Deployments, each Pod in a StatefulSet maintains a unique identifier and stable storage.
  - **Use Cases:**
    - Databases, distributed systems, and other stateful applications that require stable network identities and persistent storage.

- **StatefulSet Components:**
  - **Stable Network Identities:** Pods get persistent DNS names.
  - **Ordered Pod Management:** Supports ordered deployment, scaling, and updates.
  - **Persistent Storage:** Works with PVCs to provide persistent storage for each Pod.

- **Example StatefulSet Configuration:**
  ```yaml
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: web
  spec:
    selector:
      matchLabels:
        app: nginx
    serviceName: "nginx"
    replicas: 3
    template:
      metadata:
        labels:
          app: nginx
      spec:
        containers:
        - name: nginx
          image: k8s.gcr.io/nginx-slim:0.8
          volumeMounts:
          - name: www
            mountPath: /usr/share/nginx/html
    volumeClaimTemplates:
    - metadata:
        name: www
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 1Gi
  ```

##### **11.d. Code Sample: Persistent Volume and Persistent Volume Claim Configuration**

- **1. Create a Persistent Volume (PV):**
  - **PV Configuration:**
    ```yaml
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: example-pv
    spec:
      capacity:
        storage: 10Gi
      accessModes:
        - ReadWriteOnce
      persistentVolumeReclaimPolicy: Retain
      storageClassName: manual
      hostPath:
        path: /mnt/data
    ```
  - **Apply the PV:**
    ```sh
    kubectl apply -f pv.yaml
    ```

- **2. Create a Persistent Volume Claim (PVC):**
  - **PVC Configuration:**
    ```yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: example-pvc
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 8Gi
      storageClassName: manual
    ```
  - **Apply the PVC:**
    ```sh
    kubectl apply -f pvc.yaml
    ```

- **3. Use the PVC in a Pod:**
  - **Pod Configuration with PVC:**
    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: pv-pod
    spec:
      containers:
      - name: my-container
        image: nginx
        volumeMounts:
        - mountPath: "/usr/share/nginx/html"
          name: my-pv-storage
      volumes:
      - name: my-pv-storage
        persistentVolumeClaim:
          claimName: example-pvc
    ```
  - **Apply the Pod Configuration:**
    ```sh
    kubectl apply -f pod.yaml
    ```

  - **Verify the Pod and Volume:**
    ```sh
    kubectl get pods pv-pod
    kubectl get pvc example-pvc
    ```

---

These notes provide an in-depth understanding of persistent storage in Kubernetes, covering the core concepts, practical examples, and best practices. This section ensures that your applications can reliably manage and maintain data across different environments and lifecycles.
